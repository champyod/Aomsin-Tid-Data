name: AI Pipeline & Dashboard CI/CD

on:
  push:
    branches: ["main", "releases"]
  pull_request:
    branches: ["main", "releases"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      clean: ${{ steps.filter.outputs.clean }}
      analysis: ${{ steps.filter.outputs.analysis }}
      modeling: ${{ steps.filter.outputs.modeling }}
      dashboard: ${{ steps.filter.outputs.dashboard }}
      lib: ${{ steps.filter.outputs.lib }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            clean:
              - 'notebooks/preprocessing/**'
            analysis:
              - 'notebooks/analysis/**'
            modeling:
              - 'notebooks/modeling/**'
            dashboard:
              - 'dashboard/**'
            lib:
              - 'src/**'
              - 'pyproject.toml'
              - 'uv.lock'
              - '.github/workflows/main.yml'

  cleaning:
    needs: changes
    if: ${{ needs.changes.outputs.clean == 'true' || needs.changes.outputs.lib == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv sync
      - name: Run Cleaning
        run: |
          for notebook in notebooks/preprocessing/*.ipynb; do
            echo "Running $notebook..."
            uv run jupyter nbconvert --to notebook --execute "$notebook"
          done
      - name: Upload Clean Data
        uses: actions/upload-artifact@v4
        with:
          name: clean-data
          path: data/
          retention-days: 5

  analysis:
    needs: [changes, cleaning]
    if: ${{ always() && (needs.changes.outputs.analysis == 'true' || needs.changes.outputs.clean == 'true' || needs.changes.outputs.lib == 'true') && (needs.cleaning.result == 'success' || needs.cleaning.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv sync

      - name: Download Clean Data (Current)
        if: ${{ needs.cleaning.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: clean-data
          path: data

      - name: Download Clean Data (Latest from Main)
        if: ${{ needs.cleaning.result == 'skipped' }}
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: main.yml
          name: clean-data
          path: data
          if_no_artifact_found: warn

      - name: Run Analysis
        run: |
          for notebook in notebooks/analysis/*.ipynb; do
            echo "Running $notebook..."
            uv run jupyter nbconvert --to notebook --execute "$notebook"
          done
      
      - name: Upload Analysis Data
        uses: actions/upload-artifact@v4
        with:
          name: analysis-data
          path: data/
          retention-days: 5

  modeling:
    needs: [changes, analysis]
    if: ${{ always() && (needs.changes.outputs.modeling == 'true' || needs.changes.outputs.analysis == 'true' || needs.changes.outputs.clean == 'true' || needs.changes.outputs.lib == 'true') && (needs.analysis.result == 'success' || needs.analysis.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv sync

      - name: Download Analysis Data (Current)
        if: ${{ needs.analysis.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: analysis-data
          path: data

      - name: Download Analysis Data (Latest from Main)
        if: ${{ needs.analysis.result == 'skipped' }}
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: main.yml
          name: analysis-data
          path: data
          if_no_artifact_found: warn

      - name: Run Modeling (Training & Testing)
        run: |
          echo "Running Training..."
          for notebook in notebooks/modeling/train/*.ipynb; do
            if [ -f "$notebook" ]; then
              echo "Running $notebook..."
              uv run jupyter nbconvert --to notebook --execute "$notebook"
            fi
          done
          echo "Running Testing..."
          for notebook in notebooks/modeling/test/*.ipynb; do
            if [ -f "$notebook" ]; then
              echo "Running $notebook..."
              uv run jupyter nbconvert --to notebook --execute "$notebook"
            fi
          done

      - name: Upload Model Data
        uses: actions/upload-artifact@v4
        with:
          name: model-data
          path: data/
          retention-days: 5

  # JOB 1: Build Dashboard (Verified on PRs)
  dashboard-build:
    needs: [changes, modeling]
    if: ${{ always() && (needs.changes.outputs.dashboard == 'true' || needs.changes.outputs.modeling == 'true' || needs.changes.outputs.lib == 'true') && (needs.modeling.result == 'success' || needs.modeling.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Model Data (Current)
        if: ${{ needs.modeling.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: model-data
          path: dashboard/public/data 

      - name: Download Model Data (Latest from Main)
        if: ${{ needs.modeling.result == 'skipped' }}
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: main.yml
          name: model-data
          path: dashboard/public/data
          if_no_artifact_found: warn

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: ./dashboard
        run: bun install

      - name: Build with Next.js
        working-directory: ./dashboard
        run: bun run build

      - name: Upload result for deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dashboard/out

  # JOB 2: Deploy Dashboard (Only on Main)
  dashboard-deploy:
    needs: dashboard-build
    if: ${{ github.ref == 'refs/heads/main' }} # ONLY DEPLOY ON MAIN
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
